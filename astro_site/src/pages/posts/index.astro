---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

const posts = await getCollection('posts', ({ data }) => {
  return !data.draft;
});

// Sort posts by date, newest first
posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Render all post content for summaries
const postsWithContent = await Promise.all(
  posts.map(async (post) => {
    const { Content } = await post.render();
    return { post, Content };
  })
);
---

<Layout title="Posts">
  <h1>Posts</h1>
  
  <ul class="h-feed list">
    {postsWithContent.map(({ post, Content }, index) => (
      <li>
        <article class="h-entry">
          <header 
            style="
              display: flex;
              flex-direction: column;
              align-items: flex-start;
              justify-content: center;
              align-self: flex-start;
              font-size: small;
            "
          >
            <a 
              class="p-name"
              href={`/posts/${post.slug}/`}
              style="font-size: 1.5rem;"
            >
              {post.data.title}
            </a>
            <small>
              <span>Published by </span>
              <a class="p-author h-card" href="https://gregmakes.xyz">
                Greg
              </a>
              <span> on </span>
              <time 
                datetime={post.data.date.toISOString()}
                class="dt-published"
              >
                {post.data.date.toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric'
                })}
              </time>
            </small>
          </header>
          <main>
            <div class="e-content">
              <Content />
            </div>
          </main>
        </article>
        {index < postsWithContent.length - 1 && <hr />}
      </li>
    ))}
  </ul>
</Layout>